<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ù‚Ø±Ø¢Ù† (Ù†Ø³Ø®Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±)</title>
    <style>
        /* --- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø®Ø·ÙˆØ· --- */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;700&display=swap');

        /* --- Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù… --- */
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #e8f5e9; /* Ù„ÙˆÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø®Ø¶Ø± Ø§Ù„Ø®ÙÙŠÙ */
            color: #333;
            line-height: 1.8;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: #ffffff;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        h1, h2 {
            text-align: center;
            color: #1b5e20; /* Ø£Ø®Ø¶Ø± Ø¯Ø§ÙƒÙ† Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
            margin-bottom: 20px;
        }

        /* --- Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ --- */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
            font-size: 16px;
        }

        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        .main-btn {
            display: block;
            width: 100%;
            padding: 14px;
            background: linear-gradient(90deg, #2e7d32, #1b5e20);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .main-btn:hover:not(:disabled) {
            background: linear-gradient(90deg, #1b5e20, #003300);
            transform: translateY(-2px);
        }

        .main-btn:disabled {
            background: #aaa;
            cursor: not-allowed;
            transform: none;
        }

        /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± --- */
        .hidden { display: none; }

        #radio-group { margin-bottom: 15px; }
        #radio-group label { font-weight: normal; display: inline-block; margin-left: 10px; cursor: pointer; }

        audio { width: 100%; margin: 15px 0; }

        #questionText {
            font-size: 1.3em;
            text-align: center;
            margin-bottom: 20px;
            color: #004d40;
            font-weight: bold;
        }
        
        .ayah-text {
            font-family: 'Noto Naskh Arabic', serif; /* Ø®Ø· Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
            font-size: 1.2em;
            line-height: 1.8;
        }

        #ordering-area {
            font-family: 'Noto Naskh Arabic', serif;
            font-size: 1.2em;
            text-align: right;
            color: #333;
            line-height: 2.2;
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
            margin-top: 15px;
            min-height: 50px;
        }

        #answer-container { margin-top: 20px; }

        #choices-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        #choices-container.multi-column {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .choice-btn {
            padding: 15px;
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s;
        }

        .choice-btn.ayah-text {
            text-align: right;
        }

        .choice-btn:hover:not(:disabled) {
            background-color: #e9ecef;
            border-color: #888;
        }

        .choice-btn:disabled {
            cursor: not-allowed;
            color: #212529;
            opacity: 0.7;
        }

        /* --- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØ§Ù„Ø®Ø§Ø·Ø¦Ø© --- */
        .choice-btn.correct, .correct {
            background-color: #d4edda !important;
            color: #155724 !important;
            border-color: #c3e6cb !important;
            font-weight: bold;
        }

        .choice-btn.incorrect, .incorrect {
            background-color: #f8d7da !important;
            color: #721c24 !important;
            border-color: #f5c6cb !important;
        }

        #resultMessage {
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
        }
        .correct-msg { background-color: #d4edda; color: #155724; }
        .incorrect-msg { background-color: #f8d7da; color: #721c24; }

        #finalScore { text-align: center; font-size: 1.5em; font-weight: bold; color: #1b5e20; }
        #loader { text-align: center; font-size: 1.2em; padding: 20px; color: #004d40; }
        #telegram-status { text-align: center; margin-top: 10px; font-style: italic; color: #555; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Settings Section -->
        <div id="settings">
            <h1>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØªÙŠ Ù„Ù„Ù‚Ø±Ø¢Ù†</h1>
            <p style="text-align: center;">Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ© ÙˆÙ…ØªÙ†ÙˆØ¹Ø© Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­ÙØ¸.</p>
            
            <label for="userName">Ø§Ø³Ù…Ùƒ:</label>
            <input type="text" id="userName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">

            <label for="numQuestions">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (1-25):</label>
            <input type="number" id="numQuestions" min="1" max="25" value="10">

            <label for="reciter">Ø§Ø®ØªØ± Ø§Ù„Ø´ÙŠØ® (Ù„Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØµÙˆØªÙŠØ©):</label>
            <select id="reciter">
                <option value="ar.alafasy">Ù…Ø´Ø§Ø±ÙŠ Ø±Ø§Ø´Ø¯ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ</option>
                <option value="ar.abdulsamad">Ø¹Ø¨Ø¯ Ø§Ù„Ø¨Ø§Ø³Ø· Ø¹Ø¨Ø¯ Ø§Ù„ØµÙ…Ø¯ (Ù…Ø±ØªÙ„)</option>
                <option value="ar.sudais">Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø¯ÙŠØ³</option>
            </select>
            
            <label>Ø§Ø®ØªØ± Ù…Ø¬Ø§Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:</label>
            <div id="radio-group">
                <input type="radio" id="byPage" name="selectionType" value="page" checked>
                <label for="byPage">ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©</label>
                <input type="radio" id="byRange" name="selectionType" value="range" style="margin-right: 20px;">
                <label for="byRange">Ù…Ø¬Ø§Ù„ Ù…Ù† Ø§Ù„ØµÙØ­Ø§Øª</label>
            </div>

            <div id="pageInput">
                <label for="pageNumber">Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© (1 - 604):</label>
                <input type="number" id="pageNumber" min="1" max="604" value="50">
            </div>
            <div id="rangeInput" class="hidden">
                <label for="startPage">Ù…Ù† ØµÙØ­Ø©:</label>
                <input type="number" id="startPage" min="1" max="604" value="50">
                <label for="endPage">Ø¥Ù„Ù‰ ØµÙØ­Ø©:</label>
                <input type="number" id="endPage" min="1" max="604" value="55">
            </div>
            <button id="startBtn" class="main-btn">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
        </div>

        <!-- Quiz Section -->
        <div id="quizArea" class="hidden">
            <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ <span id="quizUserName"></span>!</h2>
            <div id="loader">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„...</div>
            <div id="quizContent" class="hidden">
                <p id="questionText"></p>
                <div id="intruderAyahsText" class="hidden ayah-text"></div>
                <audio id="audioPlayer" controls></audio>
                <div id="answer-container"></div>
                <div id="resultMessage" class="hidden"></div>
                <button id="nextQuestionBtn" class="main-btn hidden">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <h2>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h2>
            <p id="finalScore"></p>
            <p id="telegram-status"></p>
            <button class="main-btn" onclick="location.reload()">Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const settingsDiv = document.getElementById('settings');
        const quizAreaDiv = document.getElementById('quizArea');
        const resultsDiv = document.getElementById('results');
        const startBtn = document.getElementById('startBtn');
        const finalScoreP = document.getElementById('finalScore');
        const telegramStatusP = document.getElementById('telegram-status');
        const quizUserName = document.getElementById('quizUserName');
        const loader = document.getElementById('loader');
        const quizContent = document.getElementById('quizContent');
        const byPageRadio = document.getElementById('byPage');
        const byRangeRadio = document.getElementById('byRange');
        const pageInputDiv = document.getElementById('pageInput');
        const rangeInputDiv = document.getElementById('rangeInput');
        const audioPlayer = document.getElementById('audioPlayer');
        const questionText = document.getElementById('questionText');
        const intruderAyahsTextDiv = document.getElementById('intruderAyahsText');
        const answerContainer = document.getElementById('answer-container');
        const resultMessage = document.getElementById('resultMessage');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');

        // --- State Variables ---
        let allAyahs = [];
        let questionPool = [];
        let currentQuestionType = '';
        let correctAnswer = null;
        let score = 0;
        let questionsAsked = 0;
        let totalQuestions = 10;
        let mistakes = [];
        let intruderCorrectIndex = -1;
        let audioQueue = [];
        let currentAudioIndex = 0;
        
        const mutashabihatDB = [
            { surah: 2, numberInSurah: 61, text: 'ÙˆÙØ¨ÙØ§Ø¡ÙÙˆØ§ Ø¨ÙØºÙØ¶ÙØ¨Ù Ù…Ù‘ÙÙ†Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù', similarTo: { number: 301, text: 'ÙˆÙØ¨ÙØ§Ø¡ÙÙˆØ§ Ø¨ÙØºÙØ¶ÙØ¨Ù Ù…Ù‘ÙÙ†Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ûš Ø°ÙÙ°Ù„ÙÙƒÙ' } },
            { surah: 8, numberInSurah: 58, text: 'Ø¥ÙÙ†Ù‘Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ù„ÙØ§ ÙŠÙØ­ÙØ¨Ù‘Ù Ø§Ù„Ù’Ø®ÙØ§Ø¦ÙÙ†ÙÙŠÙ†Ù', similarTo: { number: 636, text: 'Ø¥ÙÙ†Ù‘Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ù„ÙØ§ ÙŠÙØ­ÙØ¨Ù‘Ù Ù…ÙÙ† ÙƒÙØ§Ù†Ù Ø®ÙÙˆÙ‘ÙØ§Ù†Ù‹Ø§ Ø£ÙØ«ÙÙŠÙ…Ù‹Ø§' } },
        ];

        // --- Event Listeners ---
        function updateSelectionUI() {
            pageInputDiv.classList.toggle('hidden', !byPageRadio.checked);
            rangeInputDiv.classList.toggle('hidden', byPageRadio.checked);
        }
        byPageRadio.addEventListener('change', updateSelectionUI);
        byRangeRadio.addEventListener('change', updateSelectionUI);
        startBtn.addEventListener('click', startTest);
        nextQuestionBtn.addEventListener('click', nextQuestion);
        audioPlayer.addEventListener('ended', playNextInQueue);

        // --- Main Functions ---
        async function startTest() {
            const userName = document.getElementById('userName').value || 'Ø§Ù„Ù„Ø§Ø¹Ø¨';
            totalQuestions = parseInt(document.getElementById('numQuestions').value) || 10;
            if (totalQuestions > 25) totalQuestions = 25;
            if (totalQuestions < 1) totalQuestions = 1;
            
            settingsDiv.classList.add('hidden');
            quizAreaDiv.classList.remove('hidden');
            quizUserName.textContent = userName;
            
            try {
                loader.classList.remove('hidden');
                quizContent.classList.add('hidden');
                loader.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢ÙŠØ§Øª...';
                
                const testScope = byPageRadio.checked ? 'page' : 'range';
                if (testScope === 'page') {
                    const page = document.getElementById('pageNumber').value;
                    if (!page) throw new Error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©.');
                    await fetchAyahsForPage(page, document.getElementById('reciter').value);
                } else {
                    const start = document.getElementById('startPage').value;
                    const end = document.getElementById('endPage').value;
                    if (!start || !end || parseInt(start) >= parseInt(end)) {
                        throw new Error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¬Ø§Ù„ ØµÙØ­Ø§Øª ØµØ­ÙŠØ­.');
                    }
                    await fetchAyahsForRange(start, end, document.getElementById('reciter').value);
                }

                if (allAyahs.length < 5) {
                     throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø¯Ø¯ ÙƒØ§ÙÙ Ù…Ù† Ø§Ù„Ø¢ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ø§Ù„ Ø£ÙˆØ³Ø¹.');
                }

                questionsAsked = 0;
                score = 0;
                mistakes = [];
                questionPool = Array.from({length: allAyahs.length}, (_, i) => i);
                nextQuestion();

            } catch (error) {
                loader.textContent = `Ø®Ø·Ø£: ${error.message}`;
                quizAreaDiv.innerHTML += `<br><button class="main-btn" onclick="location.reload()">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>`;
            }
        }

        async function fetchAyahsForPage(page, reciter) {
            const response = await fetch(`https://api.alquran.cloud/v1/page/${page}/${reciter}`);
            if (!response.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©.');
            const data = await response.json();
            allAyahs = data.data.ayahs;
        }

        async function fetchAyahsForRange(start, end, reciter) {
            allAyahs = [];
            for (let i = parseInt(start); i <= parseInt(end); i++) {
                const response = await fetch(`https://api.alquran.cloud/v1/page/${i}/${reciter}`);
                if (!response.ok) throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØµÙØ­Ø© ${i}`);
                const data = await response.json();
                allAyahs.push(...data.data.ayahs);
            }
        }
        
        async function fetchAyahByNumber(ayahNumber, reciter) {
            const response = await fetch(`https://api.alquran.cloud/v1/ayah/${ayahNumber}/${reciter}`);
            if (!response.ok) return null;
            const data = await response.json();
            return data.data;
        }

        function nextQuestion() {
            if (questionsAsked >= totalQuestions || questionPool.length < 4) {
                showFinalResults();
                return;
            }
            questionsAsked++;
            resetUIForNewQuestion();

            let availableTypes = ['mcq_next_ayah', 'complete_ayah', 'intruder', 'mcq_order', 'mutashabihat', 'mcq_start_point'];
            if (byRangeRadio.checked) {
                availableTypes.push('mcq_page');
            }
            currentQuestionType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            
            const longAyahsPool = questionPool.filter(i => allAyahs[i].text.split(' ').length > 5);
            if ((currentQuestionType === 'mcq_start_point' || currentQuestionType === 'complete_ayah') && longAyahsPool.length === 0) {
                currentQuestionType = 'mcq_next_ayah';
            }
            if (currentQuestionType === 'mcq_next_ayah' && questionPool.every(i => i >= allAyahs.length - 1)) {
                currentQuestionType = 'complete_ayah';
            }
             if (currentQuestionType === 'mcq_order' && questionPool.length < 3) {
                currentQuestionType = 'complete_ayah';
            }

            switch (currentQuestionType) {
                case 'mcq_next_ayah': setupMCQ_NextAyah(); break;
                case 'mcq_page': setupMCQ_Page(); break;
                case 'intruder': setupIntruderTest(); break;
                case 'complete_ayah': setupCompleteAyah(); break;
                case 'mcq_order': setupMCQ_Order(); break;
                case 'mutashabihat': setupMutashabihat(); break;
                case 'mcq_start_point': setupMCQ_StartPoint(); break;
                default: setupCompleteAyah();
            }
        }

        // --- Question Setup Functions ---
        
        function setupMCQ_NextAyah() { 
            const validIndices = questionPool.filter(i => i < allAyahs.length - 1);
            if (validIndices.length === 0) { setupCompleteAyah(); return; }
            const poolIndex = Math.floor(Math.random() * validIndices.length);
            const questionIndex = validIndices[poolIndex];
            questionPool.splice(questionPool.indexOf(questionIndex), 1);
            const questionAyah = allAyahs[questionIndex];
            correctAnswer = allAyahs[questionIndex + 1];
            audioPlayer.src = questionAyah.audio;
            questionText.textContent = "Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø¢ÙŠØ©ØŒ Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªÙŠ ØªÙ„ÙŠÙ‡Ø§:";
            const wrongChoices = allAyahs.filter(a => a.number !== correctAnswer.number && a.number !== questionAyah.number).sort(() => 0.5 - Math.random()).slice(0, 3);
            const choices = shuffleArray([correctAnswer, ...wrongChoices]);
            createChoiceButtons(choices, 'ayah-text', (v) => parseInt(v) === correctAnswer.number, `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <div class="ayah-text">${correctAnswer.text}</div>`);
        }

        function setupMCQ_Page() { 
            const questionIndex = questionPool.splice(Math.floor(Math.random() * questionPool.length), 1)[0];
            const questionAyah = allAyahs[questionIndex];
            correctAnswer = questionAyah.page;
            audioPlayer.src = questionAyah.audio;
            questionText.textContent = "Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø¢ÙŠØ©ØŒ Ø«Ù… Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªÙŠ ÙˆØ±Ø¯Øª ÙÙŠÙ‡Ø§:";
            const pageNumbers = new Set([correctAnswer]);
            const minPage = parseInt(document.getElementById('startPage').value);
            const maxPage = parseInt(document.getElementById('endPage').value);
            while (pageNumbers.size < 4 && (maxPage > minPage)) {
                pageNumbers.add(Math.floor(Math.random() * (maxPage - minPage + 1)) + minPage);
            }
            const choices = shuffleArray(Array.from(pageNumbers));
            createChoiceButtons(choices, 'page-number', (v) => parseInt(v) === correctAnswer, `Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: ${correctAnswer}`);
        }

        async function setupIntruderTest() { 
            loader.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¢ÙŠØ§Øª...';
            loader.classList.remove('hidden');
            quizContent.classList.add('hidden');
            try {
                const scopeAyahsIndices = shuffleArray([...questionPool]).slice(0, 2);
                questionPool = questionPool.filter(i => !scopeAyahsIndices.includes(i));
                const scopeAyahs = scopeAyahsIndices.map(i => allAyahs[i]);
                let randomAyah;
                let isIntruderValid = false;
                const scopePageNumbers = new Set(allAyahs.map(a => a.page));
                do {
                    const randomAyahNum = Math.floor(Math.random() * 6236) + 1;
                    randomAyah = await fetchAyahByNumber(randomAyahNum, document.getElementById('reciter').value);
                    if(randomAyah) isIntruderValid = !scopePageNumbers.has(randomAyah.page);
                } while (!isIntruderValid);
                
                let ayahsForQuestion = shuffleArray([...scopeAyahs, randomAyah]);
                intruderCorrectIndex = ayahsForQuestion.findIndex(a => a.number === randomAyah.number);
                
                audioQueue = ayahsForQuestion.map(a => a.audio);
                currentAudioIndex = 0;
                loader.classList.add('hidden');
                quizContent.classList.remove('hidden');
                questionText.textContent = 'Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ø«Ù„Ø§Ø«ØŒ Ø«Ù… Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø¯Ø®ÙŠÙ„Ø©:';
                playNextInQueue();
                
                const detailedAnswer = `Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø¯Ø®ÙŠÙ„Ø© Ù‡ÙŠ Ø±Ù‚Ù… ${intruderCorrectIndex + 1}: <div class="ayah-text">${randomAyah.text}</div>`;
                createChoiceButtons([1, 2, 3], 'intruder-number', (v) => { 
                    audioPlayer.pause(); 
                    audioQueue = []; 
                    return parseInt(v) === intruderCorrectIndex + 1; 
                }, detailedAnswer);

            } catch (error) { loader.textContent = `Ø®Ø·Ø£: ${error.message}`; }
        }

        function setupCompleteAyah() { 
            audioPlayer.classList.add('hidden');
            const longAyahsPool = questionPool.filter(i => allAyahs[i].text.split(' ').length > 5);
            if (longAyahsPool.length === 0) { setupMCQ_NextAyah(); return; }
            const questionIndex = longAyahsPool[Math.floor(Math.random() * longAyahsPool.length)];
            questionPool.splice(questionPool.indexOf(questionIndex), 1);
            const questionAyah = allAyahs[questionIndex];
            const words = questionAyah.text.split(' ');
            const missingCount = Math.floor(Math.random() * 3) + 1;
            let visiblePart, questionHTML;
            if (Math.random() > 0.5) {
                correctAnswer = words.slice(0, missingCount).join(' ');
                visiblePart = words.slice(missingCount).join(' ');
                questionHTML = `<span class="ayah-text" style="color: #333; font-weight:normal;">... ${visiblePart}</span>`;
            } else {
                correctAnswer = words.slice(-missingCount).join(' ');
                visiblePart = words.slice(0, -missingCount).join(' ');
                questionHTML = `<span class="ayah-text" style="color: #333; font-weight:normal;">${visiblePart} ...</span>`;
            }
            questionText.innerHTML = `Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©: <br> ${questionHTML}`;
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Ø§ÙƒØªØ¨ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù†Ø§Ù‚Øµ Ù‡Ù†Ø§...';
            input.style.marginTop = '15px';
            const submitBtn = document.createElement('button');
            submitBtn.textContent = 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©';
            submitBtn.className = 'main-btn';
            submitBtn.style.marginTop = '10px';
            submitBtn.onclick = () => {
                input.disabled = true;
                submitBtn.disabled = true;
                const normalize = (str) => str.replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').replace(/[Ø©]/g, 'Ù‡').replace(/[\s\u064B-\u0652]/g, '').trim();
                const isCorrect = normalize(input.value) === normalize(correctAnswer);
                showResult(isCorrect, input, `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <div class="ayah-text">${correctAnswer}</div>`);
            };
            answerContainer.append(input, submitBtn);
        }

        function setupMCQ_Order() {
            if (questionPool.length < 3) { setupCompleteAyah(); return; }
            const startIndex = Math.floor(Math.random() * (questionPool.length - 3));
            const questionIndices = questionPool.slice(startIndex, startIndex + 3);
            
            const ayahsInOrder = questionIndices.map(i => allAyahs[i]);
            const ayahsShuffled = shuffleArray([...ayahsInOrder]);

            audioQueue = ayahsShuffled.map(a => a.audio);
            currentAudioIndex = 0;
            playNextInQueue();

            questionText.textContent = "Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø¢ÙŠØ§ØªØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ù†ØµÙˆØµÙ‡Ø§ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­:";
            
            const choicesContainer = document.createElement('div');
            choicesContainer.id = 'choices-container';
            const orderingArea = document.createElement('div');
            orderingArea.id = 'ordering-area';
            orderingArea.textContent = 'ØªØ±ØªÙŠØ¨Ùƒ ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...';
            answerContainer.append(orderingArea, choicesContainer);

            let userOrder = [];
            ayahsShuffled.forEach(ayah => {
                const button = document.createElement('button');
                button.className = 'choice-btn ayah-text';
                button.textContent = ayah.text;
                button.dataset.number = ayah.number;
                button.onclick = () => {
                    button.disabled = true;
                    userOrder.push(ayah);
                    orderingArea.textContent = userOrder.map(a => `(${a.numberInSurah})`).join(' â¬…ï¸ ');

                    if (userOrder.length === 3) {
                        audioPlayer.pause(); audioQueue = [];
                        const isCorrect = userOrder.every((a, i) => a.number === ayahsInOrder[i].number);
                        const correctOrderText = ayahsInOrder.map(a => `<div class="ayah-text">(${a.numberInSurah}) ${a.text}</div>`).join('');
                        showResult(isCorrect, orderingArea, `Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ùˆ:<br>${correctOrderText}`);
                    }
                };
                choicesContainer.appendChild(button);
            });
        }

        async function setupMutashabihat() {
            const potentialAyahs = allAyahs.map(ayah => {
                const match = mutashabihatDB.find(m => m.surah === ayah.surah.number && m.numberInSurah === ayah.numberInSurah);
                return match ? { scopeAyah: ayah, similarData: match.similarTo } : null;
            }).filter(Boolean);

            if (potentialAyahs.length === 0) { setupCompleteAyah(); return; }

            const { scopeAyah, similarData } = potentialAyahs[Math.floor(Math.random() * potentialAyahs.length)];
            const similarAyah = await fetchAyahByNumber(similarData.number, document.getElementById('reciter').value);

            if (!similarAyah) { setupCompleteAyah(); return; }

            const commonPart = scopeAyah.text.split(' ').slice(0, 2).join(' ');
            questionText.innerHTML = `Ø§Ø³ØªÙ…Ø¹ØŒ Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„ØªÙƒÙ…Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„Ø¢ÙŠØ© ÙÙŠ Ù…ÙˆØ¶Ø¹Ùƒ:<br><span class="ayah-text" style="font-weight:normal;">"${commonPart}..."</span>`;
            audioPlayer.src = scopeAyah.audio;

            const choices = shuffleArray([scopeAyah, similarAyah]);
            correctAnswer = scopeAyah;

            createChoiceButtons(choices, 'ayah-text', (v) => parseInt(v) === correctAnswer.number, `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙŠ Ù…ÙˆØ¶Ø¹Ùƒ Ù‡ÙŠ: <div class="ayah-text">${correctAnswer.text}</div>`);
        }

        function setupMCQ_StartPoint() {
            const longAyahsPool = questionPool.filter(i => allAyahs[i].text.split(' ').length > 5);
            if (longAyahsPool.length === 0) { setupCompleteAyah(); return; }
            const questionIndex = longAyahsPool[Math.floor(Math.random() * longAyahsPool.length)];
            questionPool.splice(questionPool.indexOf(questionIndex), 1);
            
            const questionAyah = allAyahs[questionIndex];
            const words = questionAyah.text.split(' ');
            const startWordIndex = Math.floor(Math.random() * (words.length - 3)) + 2;
            correctAnswer = words.slice(startWordIndex - 2, startWordIndex).join(' ');
            
            audioPlayer.src = questionAyah.audio;
            const partialText = words.slice(startWordIndex).join(' ');
            questionText.innerHTML = `Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø¢ÙŠØ©ØŒ Ø«Ù… Ø­Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…ØªÙŠÙ† Ø§Ù„Ù„ØªÙŠÙ† ØªØ³Ø¨Ù‚Ø§Ù† Ù…Ø¨Ø§Ø´Ø±Ø© Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØªØ§Ù„ÙŠ:<br><span class="ayah-text" style="color:#333; font-weight:normal;">"...${partialText}"</span>`;

            let wrongChoices = new Set();
            while (wrongChoices.size < 3) {
                const randomIndex = Math.floor(Math.random() * (words.length - 1));
                const wrongChoice = words.slice(randomIndex, randomIndex + 2).join(' ');
                if (wrongChoice !== correctAnswer) wrongChoices.add(wrongChoice);
            }
            const choices = shuffleArray([correctAnswer, ...Array.from(wrongChoices)]);
            createChoiceButtons(choices, 'text', (v) => v === correctAnswer, `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: "${correctAnswer}"`);
        }

        // --- UI & Logic Helpers ---

        function createChoiceButtons(choices, type, checkFunction, detailedAnswer) { 
            const choicesContainer = document.createElement('div');
            choicesContainer.id = 'choices-container';
            if (['ayah-text', 'page-number', 'text', 'intruder-number'].includes(type)) {
                choicesContainer.className = 'multi-column';
            }

            choices.forEach((choice) => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                let value, text;

                if (type === 'ayah-text') {
                    value = choice.number;
                    text = choice.text;
                    button.classList.add('ayah-text');
                } else if (type === 'page-number' || type === 'intruder-number' || type === 'text') {
                    value = text = choice;
                }
                
                button.dataset.value = value;
                button.textContent = text;

                button.onclick = () => {
                    answerContainer.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
                    const isCorrect = checkFunction(button.dataset.value);
                    showResult(isCorrect, button, detailedAnswer);
                };
                choicesContainer.appendChild(button);
            });
            answerContainer.appendChild(choicesContainer);
        }

        function playNextInQueue() {
            const isAudioQuestion = (currentQuestionType === 'intruder' || currentQuestionType === 'mcq_order');
            if (isAudioQuestion && currentAudioIndex < audioQueue.length) {
                audioPlayer.classList.remove('hidden');
                audioPlayer.src = audioQueue[currentAudioIndex];
                audioPlayer.play();
                currentAudioIndex++;
            } else if (isAudioQuestion) {
                audioPlayer.classList.add('hidden');
            }
        }

        function showResult(isCorrect, selectedElement, detailedAnswer) { 
            if (isCorrect) {
                score++;
                resultMessage.textContent = 'Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! Ø£Ø­Ø³Ù†Øª.';
                resultMessage.className = 'resultMessage correct-msg';
                selectedElement.classList.add('correct');
            } else {
                resultMessage.innerHTML = `Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©. <br> ${detailedAnswer}`;
                resultMessage.className = 'resultMessage incorrect-msg';
                selectedElement.classList.add('incorrect');
                
                // ØªØ®Ø²ÙŠÙ† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ Ù„Ù„ØªÙ‚Ø±ÙŠØ±
                const questionPrompt = document.getElementById('questionText').innerText;
                mistakes.push({
                    question: questionPrompt,
                    correction: detailedAnswer.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim()
                });
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙŠ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯
                if (currentQuestionType !== 'complete_ayah' && currentQuestionType !== 'mcq_order') {
                    answerContainer.querySelectorAll('.choice-btn').forEach(btn => {
                        let correctValue;
                        if (currentQuestionType === 'intruder') {
                            correctValue = intruderCorrectIndex + 1;
                        } else if (currentQuestionType === 'mcq_start_point' || typeof correctAnswer !== 'object') {
                            correctValue = correctAnswer;
                        } else {
                            correctValue = correctAnswer.number;
                        }
                        
                        if (btn.dataset.value == correctValue) {
                            btn.classList.add('correct');
                        }
                    });
                }
            }
            resultMessage.classList.remove('hidden');
            nextQuestionBtn.classList.remove('hidden');
        }

        async function showFinalResults() {
            const userName = document.getElementById('userName').value || 'Ø§Ù„Ù„Ø§Ø¹Ø¨';
            quizAreaDiv.classList.add('hidden');
            resultsDiv.classList.remove('hidden');
            
            const finalPercentage = (score / questionsAsked) * 100;
            finalScoreP.innerHTML = `${userName}ØŒ Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù‡ÙŠ: ${score} Ù…Ù† ${questionsAsked}<br>Ø§Ù„Ø¯Ø±Ø¬Ø©: ${finalPercentage.toFixed(1)}%`;

            telegramStatusP.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...';

            // âš ï¸âš ï¸ **Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ** âš ï¸âš ï¸
            const BOT_TOKEN = '6671455687:AAHemRdgQbmodCsqeIaha55qfPml_h9cjVQ';
            const CHANNEL_ID = '@qurantest2';

            const reportData = generateReport();

            const message = `
ğŸ“Š <b>ØªÙ‚Ø±ÙŠØ± Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø±Ø¢Ù† Ø¬Ø¯ÙŠØ¯</b> ğŸ“Š

ğŸ‘¤ <b>Ø§Ù„Ø§Ø³Ù…:</b> ${reportData.userName}
ğŸ“– <b>Ø§Ù„Ù…Ø¬Ø§Ù„:</b> ${reportData.scope}

ğŸ“ <b>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</b> ${reportData.totalQuestions}
âœ… <b>Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©:</b> ${reportData.correctAnswers}
âŒ <b>Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©:</b> ${reportData.wrongAnswers}

ğŸ† <b>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${reportData.finalResult}</b>

â–â–â–â–â–â–â–â–â–â–

${reportData.mistakes}
    `;

            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: CHANNEL_ID,
                        text: message,
                        parse_mode: 'HTML'
                    }),
                });

                const result = await response.json();
                if (result.ok) {
                    telegramStatusP.textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!';
                    telegramStatusP.style.color = 'green';
                } else {
                    throw new Error(`ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${result.description}`);
                }
            } catch (error) {
                telegramStatusP.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.';
                telegramStatusP.style.color = 'red';
                console.error('Telegram send error:', error);
            }
        }

        function generateReport() {
            const byPage = document.getElementById('byPage').checked;
            let scope;
            if (byPage) {
                scope = `ØµÙØ­Ø© ${document.getElementById('pageNumber').value}`;
            } else {
                scope = `Ù…Ù† ØµÙØ­Ø© ${document.getElementById('startPage').value} Ø¥Ù„Ù‰ ${document.getElementById('endPage').value}`;
            }

            const finalPercentage = (score / questionsAsked) * 100;

            let mistakesText = mistakes.length > 0 ? '<b>ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</b>\n' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø£Ø­Ø³Ù†Øª!';
            mistakes.forEach((mistake, index) => {
                mistakesText += `\n<b>${index + 1}. Ø§Ù„Ø³Ø¤Ø§Ù„:</b> ${mistake.question}\n   <b>Ø§Ù„ØµÙˆØ§Ø¨:</b> ${mistake.correction}\n`;
            });

            return {
                userName: document.getElementById('userName').value || 'Ø§Ù„Ù„Ø§Ø¹Ø¨',
                scope: scope,
                totalQuestions: questionsAsked,
                correctAnswers: score,
                wrongAnswers: questionsAsked - score,
                finalResult: `${finalPercentage.toFixed(1)}%`,
                mistakes: mistakesText
            };
        }

        function resetUIForNewQuestion() {
            loader.classList.add('hidden');
            quizContent.classList.remove('hidden');
            resultMessage.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            intruderAyahsTextDiv.classList.add('hidden');
            intruderAyahsTextDiv.innerHTML = '';
            answerContainer.innerHTML = '';
            audioPlayer.classList.remove('hidden');
            audioPlayer.pause();
            audioPlayer.src = '';
            audioQueue = [];
            currentAudioIndex = 0;
            intruderCorrectIndex = -1;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    });
    </script>

</body>
</html>
