<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الاختبار الشامل للقرآن (7 في 1 - نسخة مصححة نهائياً)</title>
    <style>
        /* الستايل يبقى كما هو بدون تغيير */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f0f4f8; color: #333; line-height: 1.8; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { max-width: 800px; width: 100%; background: #fff; padding: 25px 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #006400; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        .main-btn { display: block; width: 100%; padding: 12px; background: linear-gradient(90deg, #28a745, #218838); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold; transition: all 0.3s; }
        .main-btn:hover:not(:disabled) { background: linear-gradient(90deg, #218838, #1e7e34); transform: translateY(-2px); }
        .main-btn:disabled { background: #aaa; cursor: not-allowed; transform: none; }
        .hidden { display: none; }
        #radio-group { margin-bottom: 15px; }
        #radio-group label { font-weight: normal; display: inline-block; margin-left: 10px; cursor: pointer; }
        audio { width: 100%; margin: 15px 0; }
        #questionText, #intruderAyahsText { font-size: 1.2em; text-align: center; margin-bottom: 15px; color: #0056b3; font-weight: bold; }
        #intruderAyahsText, #ordering-area { font-size: 1.1em; text-align: right; color: #333; font-weight: normal; line-height: 2; border: 1px solid #eee; padding: 15px; border-radius: 8px; background-color: #f8f9fa; }
        #answer-container { margin-top: 15px; }
        #choices-container { display: grid; grid-template-columns: 1fr; gap: 10px; }
        #choices-container.multi-column { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        .choice-btn { padding: 15px; font-size: 16px; font-family: 'Cairo', sans-serif; text-align: center; border: 1px solid #ccc; border-radius: 8px; background-color: #f8f9fa; cursor: pointer; transition: all 0.2s; }
        .choice-btn.ayah-text { text-align: right; }
        .choice-btn:hover:not(:disabled) { background-color: #e9ecef; border-color: #888; }
        .choice-btn:disabled { cursor: not-allowed; color: #212529; opacity: 0.6; }
        .choice-btn.correct, .correct { background-color: #d4edda !important; color: #155724 !important; border-color: #c3e6cb !important; font-weight: bold; }
        .choice-btn.incorrect, .incorrect { background-color: #f8d7da !important; color: #721c24 !important; border-color: #f5c6cb !important; }
        #ordering-area { min-height: 50px; }
        #resultMessage { padding: 15px; margin-top: 15px; border-radius: 5px; text-align: center; font-size: 1.1em; }
        #finalScore { text-align: center; font-size: 1.5em; font-weight: bold; }
        #loader { text-align: center; font-size: 1.2em; padding: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Settings Section -->
        <div id="settings">
            <h1>الاختبار الشامل للقرآن (7 في 1)</h1>
            <p style="text-align: center;">اختبارات ذكية ومتنوعة لتثبيت الحفظ.</p>
            <label for="userName">اسمك:</label>
            <input type="text" id="userName" placeholder="أدخل اسمك هنا">
            <label for="reciter">اختر الشيخ (للأسئلة الصوتية):</label>
            <select id="reciter">
                <option value="ar.alafasy">مشاري راشد العفاسي</option>
                <option value="ar.abdulsamad">عبد الباسط عبد الصمد (مرتل)</option>
                <option value="ar.sudais">عبد الرحمن السديس</option>
            </select>
            
            <label>اختر مجال المراجعة:</label>
            <div id="radio-group">
                <input type="radio" id="byPage" name="selectionType" value="page" checked>
                <label for="byPage">صفحة واحدة</label>
                <input type="radio" id="byRange" name="selectionType" value="range" style="margin-right: 20px;">
                <label for="byRange">مجال من الصفحات</label>
            </div>

            <div id="pageInput">
                <label for="pageNumber">رقم الصفحة (1 - 604):</label>
                <input type="number" id="pageNumber" min="1" max="604" value="50">
            </div>
            <div id="rangeInput" class="hidden">
                <label for="startPage">من صفحة:</label>
                <input type="number" id="startPage" min="1" max="604" value="50">
                <label for="endPage">إلى صفحة:</label>
                <input type="number" id="endPage" min="1" max="604" value="55">
            </div>
            <button id="startBtn" class="main-btn">بدء الاختبار</button>
        </div>

        <!-- Quiz Section -->
        <div id="quizArea" class="hidden">
            <h2>مرحباً يا <span id="quizUserName"></span>!</h2>
            <div id="loader">جاري تحضير السؤال...</div>
            <div id="quizContent" class="hidden">
                <p id="questionText"></p>
                <div id="intruderAyahsText" class="hidden"></div>
                <audio id="audioPlayer" controls></audio>
                <div id="answer-container"></div>
                <div id="resultMessage" class="hidden"></div>
                <button id="nextQuestionBtn" class="main-btn hidden">السؤال التالي</button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <h2>انتهى الاختبار!</h2>
            <p id="finalScore"></p>
            <button class="main-btn" onclick="location.reload()">البدء من جديد</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const settingsDiv = document.getElementById('settings');
            const quizAreaDiv = document.getElementById('quizArea');
            const resultsDiv = document.getElementById('results');
            const loader = document.getElementById('loader');
            const quizContent = document.getElementById('quizContent');
            const startBtn = document.getElementById('startBtn');
            const byPageRadio = document.getElementById('byPage');
            const byRangeRadio = document.getElementById('byRange');
            const pageInputDiv = document.getElementById('pageInput');
            const rangeInputDiv = document.getElementById('rangeInput');
            const quizUserName = document.getElementById('quizUserName');
            const audioPlayer = document.getElementById('audioPlayer');
            const questionText = document.getElementById('questionText');
            const intruderAyahsTextDiv = document.getElementById('intruderAyahsText');
            const answerContainer = document.getElementById('answer-container');
            const resultMessage = document.getElementById('resultMessage');
            const nextQuestionBtn = document.getElementById('nextQuestionBtn');
            const finalScoreP = document.getElementById('finalScore');

            // --- State Variables ---
            let allAyahs = [];
            let questionPool = [];
            let currentQuestionType = '';
            let correctAnswer = null;
            let score = 0;
            let questionsAsked = 0;
            const TOTAL_QUESTIONS = 10;
            let audioQueue = [];
            let currentAudioIndex = 0;

            // --- Database for Mutashabihat ---
            const mutashabihatDB = [
                { surah: 2, numberInSurah: 61, text: 'وَبَاءُوا بِغَضَبٍ مِّنَ اللَّهِ', similarTo: { number: 301, text: 'وَبَاءُوا بِغَضَبٍ مِّنَ اللَّهِ ۚ ذَٰلِكَ' } },
                { surah: 8, numberInSurah: 58, text: 'إِنَّ اللَّهَ لَا يُحِبُّ الْخَائِنِينَ', similarTo: { number: 636, text: 'إِنَّ اللَّهَ لَا يُحِبُّ مَن كَانَ خَوَّانًا أَثِيمًا' } },
                { surah: 30, numberInSurah: 59, text: 'كَذَٰلِكَ يَطْبَعُ اللَّهُ عَلَىٰ قُلُوبِ الَّذِينَ لَا يَعْلَمُونَ', similarTo: { number: 4194, text: 'كَذَٰلِكَ يَطْبَعُ اللَّهُ عَلَىٰ كُلِّ قَلْبِ مُتَكَبِّرٍ جَبَّارٍ' } }
            ];

            // --- Event Listeners ---
            //  ====>  START OF THE FIX <====
            function updateSelectionUI() {
                if (byPageRadio.checked) {
                    pageInputDiv.classList.remove('hidden');
                    rangeInputDiv.classList.add('hidden');
                } else {
                    pageInputDiv.classList.add('hidden');
                    rangeInputDiv.classList.remove('hidden');
                }
            }
            byPageRadio.addEventListener('change', updateSelectionUI);
            byRangeRadio.addEventListener('change', updateSelectionUI);
            //  ====>  END OF THE FIX <====

            startBtn.addEventListener('click', startTest);
            nextQuestionBtn.addEventListener('click', nextQuestion);
            audioPlayer.addEventListener('ended', playNextInQueue);

            // --- Main Functions ---
            async function startTest() {
                const userName = document.getElementById('userName').value || 'اللاعب';
                const testScope = byPageRadio.checked ? 'page' : 'range';
                
                settingsDiv.classList.add('hidden');
                quizAreaDiv.classList.remove('hidden');
                quizUserName.textContent = userName;
                
                try {
                    loader.classList.remove('hidden');
                    quizContent.classList.add('hidden');
                    loader.textContent = 'جاري تحميل بيانات الآيات...';
                    
                    if (testScope === 'page') {
                        const page = document.getElementById('pageNumber').value;
                        if (!page) throw new Error('الرجاء إدخال رقم الصفحة.');
                        await fetchAyahsForPage(page, document.getElementById('reciter').value);
                    } else {
                        const start = document.getElementById('startPage').value;
                        const end = document.getElementById('endPage').value;
                        if (!start || !end || parseInt(start) >= parseInt(end)) {
                            throw new Error('الرجاء إدخال مجال صفحات صحيح.');
                        }
                        await fetchAyahsForRange(start, end, document.getElementById('reciter').value);
                    }

                    if (allAyahs.length < 5) {
                         throw new Error('لا يوجد عدد كافٍ من الآيات في هذا النطاق. الرجاء اختيار مجال أوسع.');
                    }

                    questionsAsked = 0;
                    score = 0;
                    questionPool = Array.from({length: allAyahs.length}, (_, i) => i);
                    nextQuestion();

                } catch (error) {
                    loader.textContent = `خطأ: ${error.message}`;
                }
            }

            async function fetchAyahsForPage(page, reciter) {
                const response = await fetch(`https://api.alquran.cloud/v1/page/${page}/${reciter}`);
                if (!response.ok) throw new Error('فشل الاتصال بالشبكة.');
                const data = await response.json();
                allAyahs = data.data.ayahs;
            }

            async function fetchAyahsForRange(start, end, reciter) {
                allAyahs = [];
                for (let i = parseInt(start); i <= parseInt(end); i++) {
                    const response = await fetch(`https://api.alquran.cloud/v1/page/${i}/${reciter}`);
                    if (!response.ok) throw new Error(`فشل في جلب بيانات صفحة ${i}`);
                    const data = await response.json();
                    allAyahs.push(...data.data.ayahs);
                }
            }
            
            async function fetchAyahByNumber(ayahNumber, reciter) {
                const response = await fetch(`https://api.alquran.cloud/v1/ayah/${ayahNumber}/${reciter}`);
                if (!response.ok) return null;
                const data = await response.json();
                return data.data;
            }

            function nextQuestion() {
                if (questionsAsked >= TOTAL_QUESTIONS || questionPool.length < 4) {
                    showFinalResults();
                    return;
                }
                questionsAsked++;
                resetUIForNewQuestion();

                let availableTypes = ['mcq_next_ayah', 'complete_ayah', 'intruder', 'mcq_order', 'mutashabihat', 'mcq_start_point'];
                if (byRangeRadio.checked) {
                    availableTypes.push('mcq_page');
                }
                currentQuestionType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
                
                // Fallback logic
                const longAyahsPool = questionPool.filter(i => allAyahs[i].text.split(' ').length > 5);
                if ((currentQuestionType === 'mcq_start_point' || currentQuestionType === 'complete_ayah') && longAyahsPool.length === 0) {
                    currentQuestionType = 'mcq_next_ayah';
                }
                if (currentQuestionType === 'mcq_next_ayah' && questionPool.every(i => i >= allAyahs.length - 1)) {
                    currentQuestionType = 'complete_ayah';
                }
                 if (currentQuestionType === 'mcq_order' && questionPool.length < 3) {
                    currentQuestionType = 'complete_ayah';
                }

                switch (currentQuestionType) {
                    case 'mcq_next_ayah': setupMCQ_NextAyah(); break;
                    case 'mcq_page': setupMCQ_Page(); break;
                    case 'intruder': setupIntruderTest(); break;
                    case 'complete_ayah': setupCompleteAyah(); break;
                    case 'mcq_order': setupMCQ_Order(); break;
                    case 'mutashabihat': setupMutashabihat(); break;
                    case 'mcq_start_point': setupMCQ_StartPoint(); break;
                    default: setupCompleteAyah();
                }
            }

            // --- Question Setup Functions (All 7 of them) ---
            // The implementation of these functions remains the same as the last correct version.
            // To avoid excessive length, I will omit them here, but they are unchanged.
            // ... (All setup functions like setupMCQ_NextAyah, setupMCQ_Page, etc., go here) ...
            
            // --- UI & Logic Helpers ---
            // ... (All helper functions like createChoiceButtons, playNextInQueue, etc., go here) ...

            // Pasting the functions again for completeness
            function setupMCQ_NextAyah() { 
                const validIndices = questionPool.filter(i => i < allAyahs.length - 1);
                if (validIndices.length === 0) { setupCompleteAyah(); return; }
                const poolIndex = Math.floor(Math.random() * validIndices.length);
                const questionIndex = validIndices[poolIndex];
                questionPool.splice(questionPool.indexOf(questionIndex), 1);
                const questionAyah = allAyahs[questionIndex];
                correctAnswer = allAyahs[questionIndex + 1];
                audioPlayer.src = questionAyah.audio;
                questionText.textContent = "استمع للآية، ثم اختر الآية التي تليها:";
                const wrongChoices = allAyahs.filter(a => a.number !== correctAnswer.number && a.number !== questionAyah.number).sort(() => 0.5 - Math.random()).slice(0, 3);
                const choices = shuffleArray([correctAnswer, ...wrongChoices]);
                createChoiceButtons(choices, 'ayah-text', (v) => parseInt(v) === correctAnswer.number, `الإجابة الصحيحة: "${correctAnswer.text}"`);
            }
            function setupMCQ_Page() { 
                const questionIndex = questionPool.splice(Math.floor(Math.random() * questionPool.length), 1)[0];
                const questionAyah = allAyahs[questionIndex];
                correctAnswer = questionAyah.page;
                audioPlayer.src = questionAyah.audio;
                questionText.textContent = "استمع للآية، ثم اختر رقم الصفحة التي وردت فيها:";
                const pageNumbers = new Set([correctAnswer]);
                const minPage = parseInt(document.getElementById('startPage').value);
                const maxPage = parseInt(document.getElementById('endPage').value);
                while (pageNumbers.size < 4 && (maxPage > minPage)) {
                    pageNumbers.add(Math.floor(Math.random() * (maxPage - minPage + 1)) + minPage);
                }
                const choices = shuffleArray(Array.from(pageNumbers));
                createChoiceButtons(choices, 'page-number', (v) => parseInt(v) === correctAnswer, `الصفحة الصحيحة هي: ${correctAnswer}`);
            }
            async function setupIntruderTest() { 
                loader.textContent = 'جاري تحضير الآيات...';
                loader.classList.remove('hidden');
                quizContent.classList.add('hidden');
                try {
                    const scopeAyahsIndices = shuffleArray([...questionPool]).slice(0, 2);
                    questionPool = questionPool.filter(i => !scopeAyahsIndices.includes(i));
                    const scopeAyahs = scopeAyahsIndices.map(i => allAyahs[i]);
                    let randomAyah;
                    let isIntruderValid = false;
                    const scopePageNumbers = new Set(allAyahs.map(a => a.page));
                    do {
                        const randomAyahNum = Math.floor(Math.random() * 6236) + 1;
                        randomAyah = await fetchAyahByNumber(randomAyahNum, document.getElementById('reciter').value);
                        if(randomAyah) isIntruderValid = !scopePageNumbers.has(randomAyah.page);
                    } while (!isIntruderValid);
                    let ayahsForQuestion = shuffleArray([...scopeAyahs, randomAyah]);
                    const intruderCorrectIndex = ayahsForQuestion.findIndex(a => a.number === randomAyah.number);
                    intruderAyahsTextDiv.innerHTML = ayahsForQuestion.map((ayah, index) => `<b>(${index + 1})</b> ${ayah.text}`).join('<br>');
                    audioQueue = ayahsForQuestion.map(a => a.audio);
                    currentAudioIndex = 0;
                    loader.classList.add('hidden');
                    quizContent.classList.remove('hidden');
                    questionText.textContent = 'استمع للآيات الثلاث، ثم اختر رقم الآية الدخيلة:';
                    playNextInQueue();
                    createChoiceButtons([1, 2, 3], 'intruder-number', (v) => { audioPlayer.pause(); audioQueue = []; return parseInt(v) === intruderCorrectIndex; }, `الآية الدخيلة هي رقم ${intruderCorrectIndex + 1}: "${randomAyah.text}"`);
                } catch (error) { loader.textContent = `خطأ: ${error.message}`; }
            }
            function setupCompleteAyah() { 
                audioPlayer.classList.add('hidden');
                const longAyahsPool = questionPool.filter(i => allAyahs[i].text.split(' ').length > 5);
                if (longAyahsPool.length === 0) { setupMCQ_NextAyah(); return; }
                const questionIndex = longAyahsPool[Math.floor(Math.random() * longAyahsPool.length)];
                questionPool.splice(questionPool.indexOf(questionIndex), 1);
                const questionAyah = allAyahs[questionIndex];
                const words = questionAyah.text.split(' ');
                const missingCount = Math.floor(Math.random() * 3) + 1;
                let visiblePart, questionHTML;
                if (Math.random() > 0.5) {
                    correctAnswer = words.slice(0, missingCount).join(' ');
                    visiblePart = words.slice(missingCount).join(' ');
                    questionHTML = `<span style="color: #333; font-weight:normal;">... ${visiblePart}</span>`;
                } else {
                    correctAnswer = words.slice(-missingCount).join(' ');
                    visiblePart = words.slice(0, -missingCount).join(' ');
                    questionHTML = `<span style="color: #333; font-weight:normal;">${visiblePart} ...</span>`;
                }
                questionText.innerHTML = `أكمل الآية التالية: <br> ${questionHTML}`;
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'اكتب الجزء الناقص هنا...';
                input.style.marginTop = '15px';
                const submitBtn = document.createElement('button');
                submitBtn.textContent = 'تحقق من الإجابة';
                submitBtn.className = 'main-btn';
                submitBtn.style.marginTop = '10px';
                submitBtn.onclick = () => {
                    input.disabled = true;
                    submitBtn.disabled = true;
                    const normalize = (str) => str.replace(/[أإآ]/g, 'ا').replace(/[ة]/g, 'ه').replace(/[\s\u064B-\u0652]/g, '').trim();
                    const isCorrect = normalize(input.value) === normalize(correctAnswer);
                    showResult(isCorrect, input, `الإجابة الصحيحة: "${correctAnswer}"`);
                };
                answerContainer.append(input, submitBtn);
            }
            function setupMCQ_Order() {
                if (questionPool.length < 3) { setupCompleteAyah(); return; }
                const startIndex = Math.floor(Math.random() * (questionPool.length - 3));
                const questionIndices = questionPool.slice(startIndex, startIndex + 3);
                
                const ayahsInOrder = questionIndices.map(i => allAyahs[i]);
                const ayahsShuffled = shuffleArray([...ayahsInOrder]);

                audioQueue = ayahsShuffled.map(a => a.audio);
                currentAudioIndex = 0;
                playNextInQueue();

                questionText.textContent = "استمع للآيات، ثم اضغط على نصوصها بالترتيب الصحيح:";
                
                const choicesContainer = document.createElement('div');
                choicesContainer.id = 'choices-container';
                const orderingArea = document.createElement('div');
                orderingArea.id = 'ordering-area';
                orderingArea.textContent = 'ترتيبك يظهر هنا...';
                answerContainer.append(orderingArea, choicesContainer);

                let userOrder = [];
                ayahsShuffled.forEach(ayah => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn ayah-text';
                    button.textContent = ayah.text;
                    button.dataset.number = ayah.number;
                    button.onclick = () => {
                        button.disabled = true;
                        userOrder.push(ayah);
                        orderingArea.textContent = userOrder.map(a => `(${a.numberInSurah})`).join(' -> ');

                        if (userOrder.length === 3) {
                            const isCorrect = userOrder.every((a, i) => a.number === ayahsInOrder[i].number);
                            const correctOrderText = ayahsInOrder.map(a => `(${a.numberInSurah}) ${a.text}`).join('<br>');
                            showResult(isCorrect, orderingArea, `الترتيب الصحيح هو:<br>${correctOrderText}`);
                        }
                    };
                    choicesContainer.appendChild(button);
                });
            }
            async function setupMutashabihat() {
                const potentialAyahs = allAyahs.map(ayah => {
                    const match = mutashabihatDB.find(m => m.surah === ayah.surah.number && m.numberInSurah === ayah.numberInSurah);
                    return match ? { scopeAyah: ayah, similarData: match.similarTo } : null;
                }).filter(Boolean);

                if (potentialAyahs.length === 0) { setupCompleteAyah(); return; }

                const { scopeAyah, similarData } = potentialAyahs[Math.floor(Math.random() * potentialAyahs.length)];
                const similarAyah = await fetchAyahByNumber(similarData.number, document.getElementById('reciter').value);

                if (!similarAyah) { setupCompleteAyah(); return; }

                const commonPart = scopeAyah.text.split(' ').slice(0, 2).join(' ');
                questionText.innerHTML = `استمع، ثم اختر التكملة الصحيحة للآية في موضعك:<br><span style="font-weight:normal;">"${commonPart}..."</span>`;
                audioPlayer.src = scopeAyah.audio;

                const choices = shuffleArray([scopeAyah, similarAyah]);
                correctAnswer = scopeAyah;

                createChoiceButtons(choices, 'ayah-text', (v) => parseInt(v) === correctAnswer.number, `الإجابة الصحيحة في موضعك هي: "${correctAnswer.text}"`);
            }
            function setupMCQ_StartPoint() {
                const longAyahsPool = questionPool.filter(i => allAyahs[i].text.split(' ').length > 5);
                if (longAyahsPool.length === 0) { setupCompleteAyah(); return; }
                const questionIndex = longAyahsPool[Math.floor(Math.random() * longAyahsPool.length)];
                questionPool.splice(questionPool.indexOf(questionIndex), 1);
                
                const questionAyah = allAyahs[questionIndex];
                const words = questionAyah.text.split(' ');
                const startWordIndex = Math.floor(Math.random() * (words.length - 3)) + 2;
                correctAnswer = words.slice(startWordIndex - 2, startWordIndex).join(' ');
                
                audioPlayer.src = questionAyah.audio;
                const partialText = words.slice(startWordIndex).join(' ');
                questionText.innerHTML = `استمع للآية، ثم حدد الكلمتين اللتين تسبقان مباشرة المقطع التالي:<br><span style="color:#333; font-weight:normal;">"...${partialText}"</span>`;

                let wrongChoices = new Set();
                while (wrongChoices.size < 3) {
                    const randomIndex = Math.floor(Math.random() * (words.length - 1));
                    const wrongChoice = words.slice(randomIndex, randomIndex + 2).join(' ');
                    if (wrongChoice !== correctAnswer) wrongChoices.add(wrongChoice);
                }
                const choices = shuffleArray([correctAnswer, ...Array.from(wrongChoices)]);
                createChoiceButtons(choices, 'text', (v) => v === correctAnswer, `الإجابة الصحيحة هي: "${correctAnswer}"`);
            }

            function createChoiceButtons(choices, type, checkFunction, detailedAnswer) { 
                const choicesContainer = document.createElement('div');
                choicesContainer.id = 'choices-container';
                choicesContainer.className = (type === 'ayah-text' || type === 'page-number' || type === 'text') ? 'multi-column' : '';
                choices.forEach((choice, index) => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    let value, text;
                    if (type === 'ayah-text') { value = choice.number; text = choice.text; button.classList.add('ayah-text'); }
                    else if (type === 'page-number') { value = text = choice; }
                    else if (type === 'intruder-number') { value = index; text = choice; }
                    else if (type === 'text') { value = text = choice; }
                    button.dataset.value = value;
                    button.textContent = text;
                    button.onclick = () => {
                        answerContainer.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
                        const isCorrect = checkFunction(button.dataset.value);
                        showResult(isCorrect, button, detailedAnswer);
                    };
                    choicesContainer.appendChild(button);
                });
                answerContainer.appendChild(choicesContainer);
            }
            function playNextInQueue() {
                const isAudioQuestion = (currentQuestionType === 'intruder' || currentQuestionType === 'mcq_order');
                if (isAudioQuestion && currentAudioIndex < audioQueue.length) {
                    audioPlayer.classList.remove('hidden');
                    audioPlayer.src = audioQueue[currentAudioIndex];
                    audioPlayer.play();
                    currentAudioIndex++;
                } else if (isAudioQuestion) {
                    if (currentQuestionType === 'intruder') intruderAyahsTextDiv.classList.remove('hidden');
                    audioPlayer.classList.add('hidden');
                }
            }
            function showResult(isCorrect, selectedElement, detailedAnswer) { 
                if (isCorrect) {
                    score++;
                    resultMessage.textContent = 'إجابة صحيحة! أحسنت.';
                    resultMessage.className = 'resultMessage correct-msg';
   
                    selectedElement.classList.add('correct');
                } else {
                    resultMessage.innerHTML = `إجابة خاطئة. <br> ${detailedAnswer}`;
                    resultMessage.className = 'resultMessage incorrect-msg';
                    selectedElement.classList.add('incorrect');
                    
                    // Highlight the correct answer for MCQ questions
                    if (currentQuestionType !== 'complete_ayah' && currentQuestionType !== 'mcq_order') {
                        answerContainer.querySelectorAll('.choice-btn').forEach(btn => {
                            let correctValue;
                            if (currentQuestionType === 'intruder') {
                                correctValue = intruderCorrectIndex;
                            } else if (currentQuestionType === 'mcq_start_point') {
                                correctValue = correctAnswer;
                            } else if (currentQuestionType === 'mcq_page') {
                                correctValue = correctAnswer;
                            }
                             else {
                                correctValue = correctAnswer.number;
                            }
                            
                            if (btn.dataset.value == correctValue) {
                                btn.classList.add('correct');
                            }
                        });
                    }
                }
                resultMessage.classList.remove('hidden');
                nextQuestionBtn.classList.remove('hidden');
            }

            function showFinalResults() {
                const userName = document.getElementById('userName').value || 'اللاعب';
                quizAreaDiv.classList.add('hidden');
                resultsDiv.classList.remove('hidden');
                finalScoreP.textContent = `${userName}، نتيجتك النهائية هي: ${score} من ${questionsAsked}`;
            }

            function resetUIForNewQuestion() {
                loader.classList.add('hidden');
                quizContent.classList.remove('hidden');
                resultMessage.classList.add('hidden');
                nextQuestionBtn.classList.add('hidden');
                intruderAyahsTextDiv.classList.add('hidden');
                intruderAyahsTextDiv.innerHTML = '';
                answerContainer.innerHTML = '';
                audioPlayer.classList.remove('hidden');
                audioPlayer.pause();
                audioPlayer.src = '';
                audioQueue = [];
                currentAudioIndex = 0;
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
        });
    </script>

</body>
</html>
