<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الاختبار الشامل للقرآن (نسخة مُحسَّنة)</title>
    <style>
        /* --- استيراد الخطوط الجديدة --- */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap' );
        @import url('https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;700&display=swap' );

        /* --- متغيرات الألوان لسهولة التعديل --- */
        :root {
            --primary-green-dark: #0d47a1;  /* أزرق داكن */
            --primary-green-light: #1976d2; /* أزرق متوسط */
            --background-color: #e3f2fd;   /* أزرق فاتح جداً */
            --container-bg: #ffffff;
            --text-color: #333;
            --correct-bg: #e8f5e9;
            --correct-text: #1b5e20;
            --incorrect-bg: #ffebee;
            --incorrect-text: #b71c1c;
            --border-color: #bbdefb;
        }

        /* --- التنسيق العام --- */
        body {
            font-family: 'Tajawal', sans-serif; /* الخط الجديد الأنيق */
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.8;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: var(--container-bg);
            padding: 30px 35px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 10px solid transparent;
            border-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M25 0 L50 25 L75 0 L100 25 L75 50 L100 75 L75 100 L50 75 L25 100 L0 75 L25 50 L0 25 Z' fill='%231976d2'/%3E%3C/svg%3E" ) 30 round;
            position: relative; /* ضروري لتحديد موضع العناصر الداخلية */
        }

        /* --- *** الإضافة: تنسيق زر الشرح والشاشة المنبثقة *** --- */
        #showHelpBtn {
            position: fixed; /* أو absolute إذا أردته داخل الـ container */
            top: 20px;
            left: 20px;
            z-index: 1000;
            padding: 10px 15px;
            background-color: var(--primary-green-dark);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        #showHelpBtn:hover {
            background-color: var(--primary-green-light);
            transform: translateY(-2px);
        }

        .modal {
            display: none; /* مخفي بشكل افتراضي */
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.5s;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px 35px;
            border: 8px solid transparent;
            border-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M25 0 L50 25 L75 0 L100 25 L75 50 L100 75 L75 100 L50 75 L25 100 L0 75 L25 50 L0 25 Z' fill='%23bbdefb'/%3E%3C/svg%3E" ) 20 round;
            width: 80%;
            max-width: 700px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .modal-content h2 {
             color: var(--primary-green-dark);
             border-bottom: 2px solid var(--border-color);
             padding-bottom: 10px;
             margin-bottom: 20px;
        }
        
        .modal-content ul {
            list-style-type: none;
            padding-right: 0;
        }
        
        .modal-content li {
            margin-bottom: 15px;
            padding-right: 25px;
            position: relative;
        }
        
        .modal-content li::before {
            content: '🔹';
            position: absolute;
            right: 0;
            top: 0;
            color: var(--primary-green-light);
        }
        
        .modal-content strong {
            color: var(--primary-green-dark);
        }

        .close-btn {
            color: #aaa;
            position: absolute;
            left: 25px;
            top: 15px;
            font-size: 32px;
            font-weight: bold;
            transition: color 0.3s;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: var(--incorrect-text);
            text-decoration: none;
            cursor: pointer;
        }
        
        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        /* --- نهاية الإضافة --- */


        h1, h2 {
            text-align: center;
            color: var(--primary-green-dark);
            margin-bottom: 20px;
            font-weight: 700;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-green-light);
            box-shadow: 0 0 8px rgba(25, 118, 210, 0.2);
        }

        .main-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, var(--primary-green-light), var(--primary-green-dark));
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-family: 'Tajawal', sans-serif;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .main-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .main-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .hidden { display: none; }
        #radio-group { margin-bottom: 20px; text-align: center; }
        #radio-group label { font-weight: normal; display: inline-block; margin: 0 15px; cursor: pointer; }
        audio { width: 100%; margin: 20px 0; }

        #questionText {
            font-size: 1.4em;
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-green-dark);
            font-weight: bold;
        }
        
        #questionText .ayah-text, .ayah-text {
            font-family: 'Noto Naskh Arabic', serif;
            font-size: 1.3em;
            line-height: 2;
            padding: 15px 20px;
            margin: 10px 0;
            border: 4px solid transparent;
            border-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M25 0 L50 25 L75 0 L100 25 L75 50 L100 75 L75 100 L50 75 L25 100 L0 75 L25 50 L0 25 Z' fill='%23bbdefb'/%3E%3C/svg%3E" ) 15 round;
            background-color: #fdfdfd;
            display: block;
        }
        
        .highlighted-word {
            color: var(--primary-green-dark);
            font-weight: bold;
            background-color: #e3f2fd;
            padding: 2px 6px;
            border-radius: 5px;
        }

        #ordering-area {
            font-family: 'Noto Naskh Arabic', serif;
            font-size: 1.2em;
            text-align: center;
            color: #333;
            line-height: 2.2;
            border: 2px dashed var(--border-color);
            padding: 15px;
            border-radius: 10px;
            background-color: #fafcff;
            margin-top: 15px;
            min-height: 50px;
        }

        #answer-container { margin-top: 20px; }
        #choices-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .choice-btn {
            padding: 15px;
            font-size: 17px;
            font-family: 'Tajawal', sans-serif;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--container-bg);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .choice-btn.ayah-text {
            text-align: right;
            font-family: 'Noto Naskh Arabic', serif;
            font-size: 1.1em;
        }
        .choice-btn:hover:not(:disabled) {
            background-color: #f1f8ff;
            border-color: var(--primary-green-light);
            transform: translateY(-2px);
        }
        .choice-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .choice-btn.correct, .correct {
            background-color: var(--correct-bg) !important;
            color: var(--correct-text) !important;
            border-color: var(--correct-text) !important;
            font-weight: bold;
        }
        .choice-btn.incorrect, .incorrect {
            background-color: var(--incorrect-bg) !important;
            color: var(--incorrect-text) !important;
            border-color: var(--incorrect-text) !important;
        }

        #resultMessage {
            padding: 15px;
            margin-top: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            border-left: 5px solid;
        }
        .correct-msg { background-color: var(--correct-bg); color: var(--correct-text); border-color: var(--correct-text); }
        .incorrect-msg { background-color: var(--incorrect-bg); color: var(--incorrect-text); border-color: var(--incorrect-text); }

        #finalScore { text-align: center; font-size: 1.6em; font-weight: bold; color: var(--primary-green-dark); }
        #loader { text-align: center; font-size: 1.2em; padding: 20px; color: var(--primary-green-dark); }
        #telegram-status { text-align: center; margin-top: 10px; font-style: italic; color: #555; }
    </style>
</head>
<body>

    <!-- *** الإضافة: زر شرح الاختبارات في الزاوية *** -->
    <button id="showHelpBtn">شرح الاختبارات</button>

    <!-- *** الإضافة: شاشة الشرح المنبثقة (Modal) *** -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>شرح أنواع الاختبارات</h2>
            <ul>
                <li><strong>أكمل الآية:</strong> استمع للآية، ثم اختر الآية الصحيحة التي تليها من الخيارات.</li>
                <li><strong>الآية السابقة:</strong> استمع للآية، ثم اختر الآية التي تسبقها مباشرة.</li>
                <li><strong>الآية الدخيلة:</strong> استمع لثلاث آيات، اثنتان من نفس الصفحة وواحدة من صفحة أخرى. مهمتك هي تحديد الآية الدخيلة.</li>
                <li><strong>ترتيب الآيات:</strong> استمع لثلاث آيات غير مرتبة، ثم اضغط على نصوصها بالترتيب الصحيح.</li>
                <li><strong>ترتيب الكلمات:</strong> ستظهر لك كلمات آية مبعثرة، قم بترتيبها لتكوين الآية الصحيحة.</li>
                <li><strong>الحكم التجويدي:</strong> استمع للآية، وحدد الحكم التجويدي للكلمة المحددة.</li>
                <li><strong>تحديد الصفحة:</strong> استمع للآية، ثم اختر رقم الصفحة الصحيح الذي وردت فيه.</li>
                <li><strong>ربط الصفحات:</strong> استمع لآخر آية في صفحة واختر أول آية في الصفحة التالية، أو العكس.</li>
                <li><strong>تخمين القارئ:</strong> استمع للآية بصوت أحد القراء المشهورين، وحاول تخمين من هو.</li>
            </ul>
        </div>
    </div>


    <div class="container">
        <!-- Settings Section -->
        <div id="settings">
            <h1>الاختبار الصوتي للقرآن</h1>
            <p style="text-align: center;">اختبارات ذكية ومتنوعة لتثبيت الحفظ.</p>
            
            <label for="userName">اسمك:</label>
            <input type="text" id="userName" placeholder="أدخل اسمك هنا">

            <label for="numQuestions">عدد الأسئلة (1-25):</label>
            <input type="number" id="numQuestions" min="1" max="25" value="10">

            <label for="reciter">اختر الشيخ (للأسئلة الصوتية):</label>
            <select id="reciter">
                <!-- Populated by JS -->
            </select>
            
            <label>اختر مجال المراجعة:</label>
            <div id="radio-group">
                <input type="radio" id="byPage" name="selectionType" value="page" checked>
                <label for="byPage">صفحة واحدة</label>
                <input type="radio" id="byRange" name="selectionType" value="range" style="margin-right: 20px;">
                <label for="byRange">مجال من الصفحات</label>
            </div>

            <div id="pageInput">
                <label for="pageNumber">رقم الصفحة (1 - 604):</label>
                <input type="number" id="pageNumber" min="1" max="604" value="50">
            </div>
            <div id="rangeInput" class="hidden">
                <label for="startPage">من صفحة:</label>
                <input type="number" id="startPage" min="1" max="604" value="50">
                <label for="endPage">إلى صفحة:</label>
                <input type="number" id="endPage" min="1" max="604" value="55">
            </div>
            <button id="startBtn" class="main-btn">بدء الاختبار</button>
        </div>

        <!-- Quiz Section -->
        <div id="quizArea" class="hidden">
            <h2>مرحباً يا <span id="quizUserName"></span>!</h2>
            <div id="loader">جاري تحضير السؤال...</div>
            <div id="quizContent" class="hidden">
                <p id="questionText"></p>
                <div id="intruderAyahsText" class="hidden ayah-text"></div>
                <audio id="audioPlayer" controls></audio>
                <div id="answer-container"></div>
                <div id="resultMessage" class="hidden"></div>
                <button id="nextQuestionBtn" class="main-btn hidden">السؤال التالي</button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <h2>انتهى الاختبار!</h2>
            <p id="finalScore"></p>
            <p id="telegram-status"></p>
            <button class="main-btn" onclick="location.reload()">البدء من جديد</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- *** الإضافة: الكود الخاص بشاشة الشرح *** ---
        const helpModal = document.getElementById('helpModal');
        const showHelpBtn = document.getElementById('showHelpBtn');
        const closeBtn = document.querySelector('.close-btn');

        showHelpBtn.onclick = () => { helpModal.style.display = "block"; }
        closeBtn.onclick = () => { helpModal.style.display = "none"; }
        window.onclick = (event) => {
            if (event.target == helpModal) {
                helpModal.style.display = "none";
            }
        }
        // --- نهاية الإضافة ---


        // --- DOM Elements ---
        const settingsDiv = document.getElementById('settings');
        const quizAreaDiv = document.getElementById('quizArea');
        const resultsDiv = document.getElementById('results');
        const startBtn = document.getElementById('startBtn');
        const finalScoreP = document.getElementById('finalScore');
        const telegramStatusP = document.getElementById('telegram-status');
        const quizUserName = document.getElementById('quizUserName');
        const loader = document.getElementById('loader');
        const quizContent = document.getElementById('quizContent');
        const byPageRadio = document.getElementById('byPage');
        const byRangeRadio = document.getElementById('byRange');
        const pageInputDiv = document.getElementById('pageInput');
        const rangeInputDiv = document.getElementById('rangeInput');
        const audioPlayer = document.getElementById('audioPlayer');
        const questionText = document.getElementById('questionText');
        const intruderAyahsTextDiv = document.getElementById('intruderAyahsText');
        const answerContainer = document.getElementById('answer-container');
        const resultMessage = document.getElementById('resultMessage');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const reciterSelect = document.getElementById('reciter');

        const reciters = {
            "ar.alafasy": "مشاري راشد العفاسي", "ar.abdulsamad": "عبد الباسط عبد الصمد (مرتل)", "ar.sudais": "عبد الرحمن السديس", "ar.mahermuaiqly": "ماهر المعيقلي", "ar.minshawi": "محمد صديق المنشاوي (مرتل)", "ar.husary": "محمود خليل الحصري", "ar.saoodshuraym": "سعود الشريم", "ar.ahmedajamy": "أحمد بن علي العجمي", "ar.abdulbasitmurattal": "عبد الباسط عبد الصمد (المصحف المجود)", "ar.husarymujawwad": "محمود خليل الحصري (مجود)", "ar.minshawimujawwad": "محمد صديق المنشاوي (مجود)", "ar.rifai": "هاني الرفاعي", "ar.tablawy": "محمد محمود الطبلاوي"
        };

        // --- State Variables ---
        let allAyahs = [];
        let questionPool = [];
        let currentQuestionType = '';
        let correctAnswer = null;
        let score = 0;
        let questionsAsked = 0;
        let totalQuestions = 10;
        let mistakes = [];
        let audioQueue = [];
        let currentAudioIndex = 0;
        
        const mutashabihatDB = [
            { surah: 2, numberInSurah: 61, text: 'وَبَاءُوا بِغَضَبٍ مِّنَ اللَّهِ', similarTo: { number: 301, text: 'وَبَاءُوا بِغَضَبٍ مِّنَ اللَّهِ ۚ ذَٰلِكَ' } },
            { surah: 8, numberInSurah: 58, text: 'إِنَّ اللَّهَ لَا يُحِبُّ الْخَائِنِينَ', similarTo: { number: 636, text: 'إِنَّ اللَّهَ لَا يُحِبُّ مَن كَانَ خَوَّانًا أَثِيمًا' } },
        ];

        function populateReciters() {
            for (const [id, name] of Object.entries(reciters)) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                reciterSelect.appendChild(option);
            }
        }

        function updateSelectionUI() {
            pageInputDiv.classList.toggle('hidden', !byPageRadio.checked);
            rangeInputDiv.classList.toggle('hidden', byPageRadio.checked);
        }
        byPageRadio.addEventListener('change', updateSelectionUI);
        byRangeRadio.addEventListener('change', updateSelectionUI);
        startBtn.addEventListener('click', startTest);
        nextQuestionBtn.addEventListener('click', nextQuestion);
        audioPlayer.addEventListener('ended', playNextInQueue);

        async function startTest() {
            const userName = document.getElementById('userName').value || 'اللاعب';
            totalQuestions = parseInt(document.getElementById('numQuestions').value) || 10;
            settingsDiv.classList.add('hidden');
            quizAreaDiv.classList.remove('hidden');
            quizUserName.textContent = userName;
            
            try {
                loader.classList.remove('hidden');
                quizContent.classList.add('hidden');
                loader.textContent = 'جاري تحميل بيانات الآيات...';
                
                const testScope = byPageRadio.checked ? 'page' : 'range';
                const selectedReciter = reciterSelect.value;

                if (testScope === 'page') {
                    await fetchAyahsForPage(document.getElementById('pageNumber').value, selectedReciter);
                } else {
                    await fetchAyahsForRange(document.getElementById('startPage').value, document.getElementById('endPage').value, selectedReciter);
                }

                if (allAyahs.length < 5) {
                     throw new Error('لا يوجد عدد كافٍ من الآيات في هذا النطاق. الرجاء اختيار مجال أوسع.');
                }

                questionsAsked = 0;
                score = 0;
                mistakes = [];
                questionPool = Array.from({length: allAyahs.length}, (_, i) => i);
                nextQuestion();

            } catch (error) {
                loader.textContent = `خطأ: ${error.message}`;
                quizAreaDiv.innerHTML += `<button class="main-btn" onclick="location.reload()">العودة</button>`;
            }
        }

        async function fetchAyahsForPage(page, reciter) {
            const response = await fetch(`https://api.alquran.cloud/v1/page/${page}/${reciter}` );
            if (!response.ok) throw new Error('فشل الاتصال بالشبكة.');
            const data = await response.json();
            allAyahs = data.data.ayahs;
        }

        async function fetchAyahsForRange(start, end, reciter) {
            allAyahs = [];
            for (let i = parseInt(start); i <= parseInt(end); i++) {
                const response = await fetch(`https://api.alquran.cloud/v1/page/${i}/${reciter}` );
                if (!response.ok) throw new Error(`فشل في جلب بيانات صفحة ${i}`);
                const data = await response.json();
                allAyahs.push(...data.data.ayahs);
            }
        }
        
        async function fetchAyahByNumber(ayahNumber, reciter) {
            const response = await fetch(`https://api.alquran.cloud/v1/ayah/${ayahNumber}/${reciter}` );
            if (!response.ok) return null;
            const data = await response.json();
            return data.data;
        }

        function nextQuestion() {
            if (questionsAsked >= totalQuestions || questionPool.length < 4) {
                showFinalResults();
                return;
            }
            questionsAsked++;
            resetUIForNewQuestion();

            let availableTypes = ['mcq_next_ayah', 'intruder', 'mcq_order', 'mcq_start_point', 'scrambled_ayah', 'find_correct_ayah', 'ayah_order_in_page', 'page_linking_test', 'guess_the_reciter', 'mcq_previous_ayah'];
            if (byRangeRadio.checked) {
                availableTypes.push('mcq_page');
            }
            currentQuestionType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            // --- Fallback logic ---
            if ((currentQuestionType === 'mcq_previous_ayah' || currentQuestionType === 'mcq_next_ayah') && allAyahs.length < 2) {
                currentQuestionType = 'find_correct_ayah';
            }
            if (currentQuestionType === 'tajweed_test') {
                const scopeAyahNumbers = new Set(allAyahs.map(a => a.number));
                const isTajweedQuestionAvailable = tajweedDB.some(t => scopeAyahNumbers.has(t.ayahNum));
                if (!isTajweedQuestionAvailable) {
                    currentQuestionType = 'mcq_next_ayah'; // Fallback if no tajweed example is in scope
                }
            }


            switch (currentQuestionType) {
                case 'mcq_next_ayah': setupMCQ_NextAyah(); break;
                case 'mcq_page': setupMCQ_Page(); break;
                case 'intruder': setupIntruderTest(); break;
                case 'mcq_order': setupMCQ_Order(); break;
                case 'mcq_start_point': setupMCQ_StartPoint(); break;
                case 'scrambled_ayah': setupScrambledAyah(); break;
                case 'find_correct_ayah': setupFindCorrectAyah(); break;
                case 'ayah_order_in_page': setupAyahOrderInPage(); break;
                case 'page_linking_test': setupPageLinkingTest(); break;
                case 'guess_the_reciter': setupGuessTheReciter(); break;
                case 'mcq_previous_ayah': setupMCQ_PreviousAyah(); break;
                default: setupMCQ_NextAyah();
            }
        }

        function setupMCQ_PreviousAyah() {
            const validIndices = questionPool.filter(i => i > 0);
            if (validIndices.length === 0) { setupMCQ_NextAyah(); return; } // Fallback

            const poolIndex = Math.floor(Math.random() * validIndices.length);
            const questionIndex = validIndices[poolIndex];
            questionPool.splice(questionPool.indexOf(questionIndex), 1);

            const questionAyah = allAyahs[questionIndex];
            correctAnswer = allAyahs[questionIndex - 1];
            
            audioPlayer.src = questionAyah.audio;
            questionText.textContent = "استمع للآية، ثم اختر الآية التي تسبقها:";

            const wrongChoices = allAyahs.filter(a => a.number !== correctAnswer.number && a.number !== questionAyah.number).sort(() => 0.5 - Math.random()).slice(0, 3);
            const choices = shuffleArray([correctAnswer, ...wrongChoices]);
            createChoiceButtons(choices, 'ayah-text', (v) => parseInt(v) === correctAnswer.number, `الإجابة الصحيحة: <div class="ayah-text">${correctAnswer.text}</div>`);
        }

        async function setupGuessTheReciter(){
            questionText.textContent="استمع للآية، ثم خمّن من هو القارئ:";
            loader.textContent="جاري تحضير السؤال الصوتي...";
            loader.classList.remove("hidden");
            quizContent.classList.add("hidden");
            try{
                const t=questionPool.splice(Math.floor(Math.random()*questionPool.length),1)[0];
                const e=allAyahs[t];
                const o=Object.keys(reciters);
                const n=o[Math.floor(Math.random()*o.length)];
                correctAnswer=n;
                const a=await fetchAyahByNumber(e.number,n);
                if(!a||!a.audio){nextQuestion();return}
                audioPlayer.src=a.audio;
                const r=o.filter(t=>t!==n);
                const s=shuffleArray(r).slice(0,2);
                const i=shuffleArray([{id:n,name:reciters[n]},{id:s[0],name:reciters[s[0]]},{id:s[1],name:reciters[s[1]]}]);
                loader.classList.add("hidden");
                quizContent.classList.remove("hidden");
                createChoiceButtons(i,"reciter",t=>t===correctAnswer,`الإجابة الصحيحة هي: الشيخ ${reciters[correctAnswer]}`);
            } catch(t) {
                loader.textContent=`خطأ في تحضير السؤال: ${t.message}`;
                setTimeout(nextQuestion,2e3);
            }
        }

        function setupMCQ_NextAyah(){
            const t=questionPool.filter(t=>t<allAyahs.length-1);
            if(0===t.length){setupMCQ_Page();return}
            const e=Math.floor(Math.random()*t.length);
            const o=t[e];
            questionPool.splice(questionPool.indexOf(o),1);
            const n=allAyahs[o];
            correctAnswer=allAyahs[o+1];
            audioPlayer.src=n.audio;
            questionText.textContent="استمع للآية، ثم اختر الآية التي تليها:";
            const a=allAyahs.filter(t=>t.number!==correctAnswer.number&&t.number!==n.number).sort(() => 0.5 - Math.random()).slice(0, 3);
            const choices = shuffleArray([correctAnswer, ...a]);
            createChoiceButtons(choices, 'ayah-text', (v) => parseInt(v) === correctAnswer.number, `الإجابة الصحيحة: <div class="ayah-text">${correctAnswer.text}</div>`);
        }

        async function setupFindCorrectAyah() {
            audioPlayer.classList.add('hidden'); 
            questionText.textContent = "اختر الآية التي تنتمي لمجال مراجعتك:";
            
            loader.textContent = 'جاري تحضير الآيات...';
            loader.classList.remove('hidden');
            quizContent.classList.add('hidden');

            try {
                const correctAyahIndex = questionPool.splice(Math.floor(Math.random() * questionPool.length), 1)[0];
                correctAnswer = allAyahs[correctAyahIndex];

                const wrongChoices = [];
                const scopePageNumbers = new Set(allAyahs.map(a => a.page));

                while (wrongChoices.length < 3) {
                    const randomAyahNum = Math.floor(Math.random() * 6236) + 1;
                    const tempAyah = await fetchAyahByNumber(randomAyahNum, 'ar.alafasy'); 
                    if (tempAyah && !scopePageNumbers.has(tempAyah.page)) {
                        wrongChoices.push(tempAyah);
                    }
                }

                const choices = shuffleArray([correctAnswer, ...wrongChoices]);
                
                loader.classList.add('hidden');
                quizContent.classList.remove('hidden');

                const detailedAnswer = `الآية الصحيحة هي: <div class="ayah-text">${correctAnswer.text}</div> (من سورة ${correctAnswer.surah.name}، صفحة ${correctAnswer.page})`;
                createChoiceButtons(choices, 'ayah-text', (v) => parseInt(v) === correctAnswer.number, detailedAnswer);

            } catch (error) {
                loader.textContent = `خطأ في تحضير السؤال: ${error.message}`;
                setTimeout(nextQuestion, 2000);
            }
        }

        async function setupAyahOrderInPage() {
            const questionIndex = questionPool.splice(Math.floor(Math.random() * questionPool.length), 1)[0];
            const questionAyah = allAyahs[questionIndex];
            
            audioPlayer.src = questionAyah.audio;
            audioPlayer.classList.remove('hidden');

            const pageNumber = questionAyah.page;
            const ayahsInThisPage = allAyahs.filter(a => a.page === pageNumber);
            const totalAyahsInPage = ayahsInThisPage.length;

            const correctOrderInPage = ayahsInThisPage.findIndex(a => a.number === questionAyah.number) + 1;
            correctAnswer = correctOrderInPage;

            questionText.innerHTML = `استمع للآية.   
 هذه الآية تقع في الصفحة رقم ${pageNumber}، والتي تحتوي على ${totalAyahsInPage} آية.   
 <b>ما هو ترتيب هذه الآية في الصفحة؟</b>`;

            const choices = new Set([correctAnswer]);
            while (choices.size < 4 && choices.size < totalAyahsInPage) {
                const randomOrder = Math.floor(Math.random() * totalAyahsInPage) + 1;
                choices.add(randomOrder);
            }
            
            const shuffledChoices = shuffleArray(Array.from(choices));
            const detailedAnswer = `الإجابة الصحيحة: الآية رقم ${correctAnswer} في الصفحة.`;

            createChoiceButtons(shuffledChoices, 'page-number', (v) => parseInt(v) === correctAnswer, detailedAnswer);
        }

        async function setupPageLinkingTest() {
            const uniquePages = [...new Set(allAyahs.map(a => a.page))];
            if (uniquePages.length < 2) {
                setupMCQ_NextAyah(); 
                return;
            }

            const isForwardLink = Math.random() > 0.5;

            let questionAyah, correctAnswerAyah;
            let foundSuitablePair = false;

            for (let i = 1; i < allAyahs.length; i++) {
                const prevAyah = allAyahs[i - 1];
                const currentAyah = allAyahs[i];

                if (currentAyah.page === prevAyah.page + 1) {
                    if (isForwardLink) {
                        questionAyah = prevAyah;
                        correctAnswerAyah = currentAyah;
                    } else {
                        questionAyah = currentAyah;
                        correctAnswerAyah = prevAyah;
                    }
                    foundSuitablePair = true;
                    break; 
                }
            }

            if (!foundSuitablePair) {
                setupMCQ_NextAyah();
                return;
            }

            audioPlayer.src = questionAyah.audio;
            correctAnswer = correctAnswerAyah;

            if (isForwardLink) {
                questionText.textContent = "استمع للآية الأخيرة في الصفحة، ثم اختر أول آية في الصفحة التالية:";
            } else {
                questionText.textContent = "استمع للآية الأولى في الصفحة، ثم اختر آخر آية في الصفحة السابقة:";
            }

            const wrongChoices = allAyahs.filter(a => 
                a.number !== correctAnswer.number && a.number !== questionAyah.number
            ).sort(() => 0.5 - Math.random()).slice(0, 3);

            const choices = shuffleArray([correctAnswer, ...wrongChoices]);
            const detailedAnswer = `الإجابة الصحيحة هي: <div class="ayah-text">${correctAnswer.text}</div>`;

            createChoiceButtons(choices, 'ayah-text', (v) => parseInt(v) === correctAnswer.number, detailedAnswer);
        }

        function setupMCQ_Page() { 
            const questionIndex = questionPool.splice(Math.floor(Math.random() * questionPool.length), 1)[0];
            const questionAyah = allAyahs[questionIndex];
            correctAnswer = questionAyah.page;
            audioPlayer.src = questionAyah.audio;
            questionText.textContent = "استمع للآية، ثم اختر رقم الصفحة التي وردت فيها:";
            const pageNumbers = new Set([correctAnswer]);
            const minPage = parseInt(document.getElementById('startPage').value);
            const maxPage = parseInt(document.getElementById('endPage').value);
            while (pageNumbers.size < 4 && (maxPage > minPage)) {
                pageNumbers.add(Math.floor(Math.random() * (maxPage - minPage + 1)) + minPage);
            }
            const choices = shuffleArray(Array.from(pageNumbers));
            createChoiceButtons(choices, 'page-number', (v) => parseInt(v) === correctAnswer,
`الصفحة الصحيحة هي: ${correctAnswer}`);
        }

        async function setupIntruderTest() { 
            loader.textContent = 'جاري تحضير الآيات...';
            loader.classList.remove('hidden');
            quizContent.classList.add('hidden');
            try {
                const scopeAyahsIndices = shuffleArray([...questionPool]).slice(0, 2);
                questionPool = questionPool.filter(i => !scopeAyahsIndices.includes(i));
                const scopeAyahs = scopeAyahsIndices.map(i => allAyahs[i]);
                let randomAyah;
                let isIntruderValid = false;
                const scopePageNumbers = new Set(allAyahs.map(a => a.page));
                do {
                    const randomAyahNum = Math.floor(Math.random() * 6236) + 1;
                    randomAyah = await fetchAyahByNumber(randomAyahNum, document.getElementById('reciter').value);
                    if(randomAyah) isIntruderValid = !scopePageNumbers.has(randomAyah.page);
                } while (!isIntruderValid);
                
                let ayahsForQuestion = shuffleArray([...scopeAyahs, randomAyah]);
                let intruderCorrectIndex = ayahsForQuestion.findIndex(a => a.number === randomAyah.number);
                
                audioQueue = ayahsForQuestion.map(a => a.audio);
                currentAudioIndex = 0;
                loader.classList.add('hidden');
                quizContent.classList.remove('hidden');
                questionText.textContent = 'استمع للآيات الثلاث، ثم اختر رقم الآية الدخيلة:';
                playNextInQueue();
                
                const detailedAnswer = `الآية الدخيلة هي رقم ${intruderCorrectIndex + 1}: <div class="ayah-text">${randomAyah.text}</div>`;
                createChoiceButtons([1, 2, 3], 'intruder-number', (v) => { 
                    audioPlayer.pause(); 
                    audioQueue = []; 
                    return parseInt(v) === intruderCorrectIndex + 1; 
                }, detailedAnswer);

            } catch (error) { loader.textContent = `خطأ: ${error.message}`; }
        }

        function setupMCQ_Order() {
            if (questionPool.length < 3) { setupMCQ_NextAyah(); return; }
            const startIndex = Math.floor(Math.random() * (questionPool.length - 3));
            const questionIndices = questionPool.slice(startIndex, startIndex + 3);
            
            const ayahsInOrder = questionIndices.map(i => allAyahs[i]);
            const ayahsShuffled = shuffleArray([...ayahsInOrder]);

            audioQueue = ayahsShuffled.map(a => a.audio);
            currentAudioIndex = 0;
            playNextInQueue();

            questionText.textContent = "استمع للآيات، ثم اضغط على نصوصها بالترتيب الصحيح:";
            
            const choicesContainer = document.createElement('div');
            choicesContainer.id = 'choices-container';
            const orderingArea = document.createElement('div');
            orderingArea.id = 'ordering-area';
            orderingArea.textContent = 'ترتيبك يظهر هنا...';
            answerContainer.append(orderingArea, choicesContainer);

            let userOrder = [];
            ayahsShuffled.forEach(ayah => {
                const button = document.createElement('button');
                button.className = 'choice-btn ayah-text';
                button.textContent = ayah.text;
                button.dataset.number = ayah.number;
                button.onclick = () => {
                    button.disabled = true;
                    userOrder.push(ayah);
                    orderingArea.textContent = userOrder.map(a => `(${a.numberInSurah})`).join(' ⬅️ ');

                    if (userOrder.length === 3) {
                        audioPlayer.pause(); audioQueue = [];
                        const isCorrect = userOrder.every((a, i) => a.number === ayahsInOrder[i].number);
                        const correctOrderText = ayahsInOrder.map(a => `<div class="ayah-text">(${a.numberInSurah}) ${a.text}</div>`).join('');
                        showResult(isCorrect, orderingArea, `الترتيب الصحيح هو:  
${correctOrderText}`);
                    }
                };
                choicesContainer.appendChild(button);
            });
        }

        function setupMCQ_StartPoint() {
            const longAyahsPool = questionPool.filter(i => allAyahs[i].text.split(' ').length > 5);
            if (longAyahsPool.length === 0) { setupMCQ_NextAyah(); return; }
            const questionIndex = longAyahsPool[Math.floor(Math.random() * longAyahsPool.length)];
            questionPool.splice(questionPool.indexOf(questionIndex), 1);
            
            const questionAyah = allAyahs[questionIndex];
            const words = questionAyah.text.split(' ');
            const startWordIndex = Math.floor(Math.random() * (words.length - 3)) + 2;
            correctAnswer = words.slice(startWordIndex - 2, startWordIndex).join(' ');
            
            audioPlayer.src = questionAyah.audio;
            const partialText = words.slice(startWordIndex).join(' ');
            questionText.innerHTML = `استمع للآية، ثم حدد الكلمتين اللتين تسبقان مباشرة المقطع التالي:  
<span class="ayah-text" style="color:#333; font-weight:normal;">"...${partialText}"</span>`;

            let wrongChoices = new Set();
            while (wrongChoices.size < 3) {
                const randomIndex = Math.floor(Math.random() * (words.length - 1));
                const wrongChoice = words.slice(randomIndex, randomIndex + 2).join(' ');
                if (wrongChoice !== correctAnswer) wrongChoices.add(wrongChoice);
            }
            const choices = shuffleArray([correctAnswer, ...Array.from(wrongChoices)]);
            createChoiceButtons(choices, 'text', (v) => v === correctAnswer, `الإجابة الصحيحة هي: "${correctAnswer}"`);
        }

        function setupScrambledAyah() {
            audioPlayer.classList.add('hidden');
            const suitableAyahsPool = questionPool.filter(i => {
                const wordCount = allAyahs[i].text.split(' ').length;
                return wordCount >= 4 && wordCount <= 10;
            });

            if (suitableAyahsPool.length === 0) {
                setupMCQ_NextAyah();
                return;
            }

            const questionIndex = suitableAyahsPool[Math.floor(Math.random() * suitableAyahsPool.length)];
            questionPool.splice(questionPool.indexOf(questionIndex), 1);
            
            const questionAyah = allAyahs[questionIndex];
            const originalWords = questionAyah.text.split(' ');
            const scrambledWords = shuffleArray([...originalWords]);

            questionText.textContent = "أعد ترتيب الكلمات التالية لتكوين الآية الصحيحة:";

            const choicesContainer = document.createElement('div');
            choicesContainer.id = 'choices-container';
            choicesContainer.className = 'multi-column';

            const orderingArea = document.createElement('div');
            orderingArea.id = 'ordering-area';
            orderingArea.className = 'ayah-text';
            orderingArea.textContent = 'الآية التي كونتها ستظهر هنا...';
            
            answerContainer.append(orderingArea, choicesContainer);

            let userOrderedWords = [];

            scrambledWords.forEach(word => {
                const button = document.createElement('button');
                button.className = 'choice-btn ayah-text';
                button.textContent = word;
                
                button.onclick = () => {
                    button.disabled = true;
                    userOrderedWords.push(word);
                    orderingArea.textContent = userOrderedWords.join(' ');

                    if (userOrderedWords.length === originalWords.length) {
                        choicesContainer.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
                        const userAnswer = userOrderedWords.join(' ');
                        const correctAnswerText = originalWords.join(' ');
                        const isCorrect = userAnswer === correctAnswerText;
                        const detailedAnswer = `الترتيب الصحيح هو: <div class="ayah-text">${correctAnswerText}</div>`;
                        showResult(isCorrect, orderingArea, detailedAnswer);
                    }
                };
                choicesContainer.appendChild(button);
            });
        }

        function createChoiceButtons(choices, type, checkFunction, detailedAnswer) { 
            const choicesContainer = document.createElement('div');
            choicesContainer.id = 'choices-container';
            if (['ayah-text', 'page-number', 'text', 'intruder-number', 'reciter'].includes(type)) {
                choicesContainer.className = 'multi-column';
            }

            choices.forEach((choice) => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                let value, text;

                if (type === 'ayah-text') {
                    value = choice.number;
                    text = choice.text;
                    button.classList.add('ayah-text');
                } else if (type === 'page-number' || type === 'intruder-number') {
                    value = text = choice;
                } else if (type === 'text') {
                    value = text = choice;
                } else if (type === 'reciter') {
                    value = choice.id;
                    text = choice.name;
                }
                
                button.dataset.value = value;
                button.textContent = text;

                button.onclick = () => {
                    answerContainer.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
                    const isCorrect = checkFunction(button.dataset.value);
                    showResult(isCorrect, button, detailedAnswer);
                };
                choicesContainer.appendChild(button);
            });
            answerContainer.appendChild(choicesContainer);
        }

        function playNextInQueue() {
            const isAudioQuestion = (currentQuestionType === 'intruder' || currentQuestionType === 'mcq_order');
            if (isAudioQuestion && currentAudioIndex < audioQueue.length) {
                audioPlayer.classList.remove('hidden');
                audioPlayer.src = audioQueue[currentAudioIndex];
                audioPlayer.play();
                currentAudioIndex++;
            } else if (isAudioQuestion) {
                audioPlayer.classList.add('hidden');
            }
        }

        function showResult(isCorrect, selectedElement, detailedAnswer) { 
            if (isCorrect) {
                score++;
                resultMessage.textContent = 'إجابة صحيحة! أحسنت.';
                resultMessage.className = 'resultMessage correct-msg';
                selectedElement.classList.add('correct');
            } else {
                resultMessage.innerHTML = `إجابة خاطئة.   
 ${detailedAnswer}`;
                resultMessage.className = 'resultMessage incorrect-msg';
                selectedElement.classList.add('incorrect');
                
                const questionPrompt = document.getElementById('questionText').innerText;
                mistakes.push({
                    question: questionPrompt,
                    correction: detailedAnswer.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim()
                });
                
                if (currentQuestionType !== 'mcq_order' && currentQuestionType !== 'scrambled_ayah') {
                    answerContainer.querySelectorAll('.choice-btn').forEach(btn => {
                        let correctValue;
                        if (currentQuestionType === 'intruder') {
                            correctValue = intruderCorrectIndex + 1;
                        } else if (typeof correctAnswer !== 'object' || currentQuestionType === 'guess_the_reciter' || currentQuestionType === 'tajweed_test') {
                            correctValue = correctAnswer;
                        } else {
                            correctValue = correctAnswer.number;
                        }
                        
                        if (btn.dataset.value == correctValue) {
                            btn.classList.add('correct');
                        }
                    });
                }
            }
            resultMessage.classList.remove('hidden');
            nextQuestionBtn.classList.remove('hidden');
        }

        async function showFinalResults() {
            const userName = document.getElementById('userName').value || 'اللاعب';
            quizAreaDiv.classList.add('hidden');
            resultsDiv.classList.remove('hidden');
            
            const finalPercentage = (questionsAsked > 0) ? (score / questionsAsked) * 100 : 0;
            finalScoreP.innerHTML = `${userName}، نتيجتك النهائية هي: ${score} من ${questionsAsked}  
الدرجة: ${finalPercentage.toFixed(1)}%`;

            telegramStatusP.textContent = 'جاري إرسال التقرير...';

            const BOT_TOKEN = '6671455687:AAHemRdgQbmodCsqeIaha55qfPml_h9cjVQ';
            const CHANNEL_ID = '@qurantest2';

            const reportData = generateReport();

            const message = `
📊 <b>تقرير اختبار قرآن جديد</b> 📊

📖 <b>المجال:</b> ${reportData.scope}
👳‍♂️ <b>الشيخ المختار:</b> ${reportData.reciterName}

📝 <b>الأسئلة:</b> ${reportData.totalQuestions}
✅ <b>إجابات صحيحة:</b> ${reportData.correctAnswers}
❌ <b>إجابات خاطئة:</b> ${reportData.wrongAnswers}

🏆 <b>النتيجة النهائية: ${reportData.finalResult}</b>

➖➖➖➖➖➖➖➖➖➖

${reportData.mistakes}
    `;

            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: CHANNEL_ID,
                        text: message,
                        parse_mode: 'HTML'
                    }    ),
                });

                const result = await response.json();
                if (result.ok) {
                    telegramStatusP.textContent = 'تم إرسال التقرير بنجاح!';
                    telegramStatusP.style.color = 'green';
                } else {
                    throw new Error(`فشل الإرسال: ${result.description}`);
                }
            } catch (error) {
                telegramStatusP.textContent = 'حدث خطأ أثناء إرسال التقرير.';
                telegramStatusP.style.color = 'red';
                console.error('Telegram send error:', error);
            }
        }

        function generateReport() {
            const byPage = document.getElementById('byPage').checked;
            let scope;
            if (byPage) {
                scope = `صفحة ${document.getElementById('pageNumber').value}`;
            } else {
                scope = `من صفحة ${document.getElementById('startPage').value} إلى ${document.getElementById('endPage').value}`;
            }

            const finalPercentage = (questionsAsked > 0) ? (score / questionsAsked) * 100 : 0;

            let mistakesText = mistakes.length > 0 ? '<b>تصحيح الأخطاء:</b>\n' : 'لا توجد أخطاء، أحسنت!';
            mistakes.forEach((mistake, index) => {
                mistakesText += `\n<b>${index + 1}. السؤال:</b> ${mistake.question}\n   <b>الصواب:</b> ${mistake.correction}\n`;
            });

            return {
                userName: document.getElementById('userName').value || 'اللاعب',
                scope: scope,
                reciterName: reciters[document.getElementById('reciter').value],
                totalQuestions: questionsAsked,
                correctAnswers: score,
                wrongAnswers: questionsAsked - score,
                finalResult: `${finalPercentage.toFixed(1)}%`,
                mistakes: mistakesText
            };
        }

        function resetUIForNewQuestion() {
            loader.classList.add('hidden');
            quizContent.classList.remove('hidden');
            resultMessage.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            intruderAyahsTextDiv.classList.add('hidden');
            intruderAyahsTextDiv.innerHTML = '';
            answerContainer.innerHTML = '';
            audioPlayer.classList.remove('hidden');
            audioPlayer.pause();
            audioPlayer.src = '';
            audioQueue = [];
            currentAudioIndex = 0;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        populateReciters();
        updateSelectionUI();
    });
    </script>

</body>
</html>
